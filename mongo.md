# [Mongo](https://www.mongodb.com/)
![](mongo.png)

MongoDB 是一个基于分布式文件存储的开源数据库。 MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。


MongoDB是专为可扩展性，高性能和高可用性而设计的数据库。它可以从单服务器部署扩展到大型、复杂的多数据中心架构。

上面简单叙述可以看出MongoDB适用场景：支持非关系型数据库，扩展方便，单服务器到多中心完备的数据架构方案，在互联网企业中方法实用。群众基础良好，使用广泛，很多使用案例可作为参考，社区里面氛围良好。

### 使用
MongoDB完整的[说明文档](https://docs.mongodb.com/)，即使用手册也是吸引用户的一点,如何配置使用，常见容易踩坑的地方多多少少都可以查询些眉目。

需要关注的地方就是每次升级提供哪些新功能，这些功能是否有坑（比如选举协议的变更这边就踩过坑，后面详述），当然有些坑是要踩过才知道。

官网下载包文件说明：


使用：1）自带mongo shell可以使用，查询，删除等操作；
     2）客户端，不同开发语言不同客户端，github上基本有源码可看，文档也很全面


#### （1）单服务器
启动：创建并指定存储数据目录，命令行直接设置参数port、IP、dbpath、log等启动，或者指定配置文件启动；配置参数详情参考文档；
#### （2）replication副本集模式
副本集模式是这边主要的使用姿势

启动：最简单的方式是单独服务都起来之后，在保证网络正常情况下，使用mongo shell的初始化命令，添加集群中节点信息，优先权信息等；例如：
集群名称"_id",集群节点"members",优先权"priority"，选举节点"arbiterOnly"等


这个集群里面5个节点，架构是3机房5副本。其中一个选举节点，优先权不同，表示被选举为master的可能不同，arbiterOnly是选举节点，本身不包含数据，不可选举为master。提供双机房服务能力。
```
rs.initiate({"_id":"bc_rs10_4","members":[{"priority":3,"host":"100.100.58.84:5104","_id":0},{"priority":2,"host":"100.100.58.84:5105","_id":1},{"priority":1,"host":"100.100.58.82:5106","_id":3},{"priority":1,"host":"100.100.58.82:5109","_id":4},{"host":"100.100.58.83:5107","_id":2,"arbiterOnly":true}]})
```
踩坑：
1）master躺尸之后，集群主从切换数据丢失；
了解mongo存储引擎和同步机制，使用wiredTiger存储引擎，推荐使用 ssd 磁盘；

关键字：【journal】、【checkpoint】、【oplog】

MongoDB 复制集里写入一个文档时，需要修改如下数据：

* 将文档数据写入对应的集合
* 更新集合的所有索引信息
* 写入一条oplog用于同步

上面3个修改操作，需要确保要么都成功，要么都失败，不能出现部分成功的情况，否则
* 如果数据写入成功，但索引写入失败，那么会出现某个数据，通过全表扫描能读取到，但通过索引就无法读取
* 如果数据、索引都写入成功，但 oplog 写入不成功，那么写入操作就不能正常的同步到备节点，出现主备数据不一致的情况

MongoDB 在写入数据时，会将上述3个操作放到一个 wiredtiger 的事务里，确保「原子性」。
wiredtiger 提交事务时，会将所有修改操作应用，并将上述3个操作写入到一条 journal操作日志里；后台会周期性的checkpoint，将修改持久化，并移除无用的journal。

【oplog】
oplog 是 MongoDB 主从复制层面的一个概念，通过 oplog 来实现复制集节点间数据同步，客户端将数据写入到 Primary，Primary 写入数据后会记录一条 oplog，Secondary 从 Primary（或其他 Secondary ）拉取 oplog 并重放，来确保复制集里每个节点存储相同的数据。oplog 在 MongoDB 里是一个普通的 capped collection，对于存储引擎来说，oplog只是一部分普通的数据而已。

【journal】



2）网络异常出现he net is partitioned,master在两个partition内跳动，集群服务异常；





